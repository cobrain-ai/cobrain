name: Release Mobile

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.1.0)'
        required: true
        type: string
      build_ios:
        description: 'Build iOS (requires secrets)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

env:
  EXPO_NO_TELEMETRY: 1

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Build workspace dependencies
        run: |
          pnpm --filter @cobrain/core build
          pnpm --filter @cobrain/database build

      - name: Setup Expo
        run: npm install -g eas-cli

      - name: Generate native project
        working-directory: apps/mobile
        run: npx expo prebuild --platform android --clean

      - name: Fix Expo module gradle plugin resolution
        working-directory: apps/mobile/android
        run: |
          echo "=== Checking settings.gradle ==="
          cat settings.gradle

          echo ""
          echo "=== Checking node_modules structure ==="
          ls -la ../node_modules/ | head -20 || true
          ls -la ../node_modules/expo-modules-core/android/ 2>/dev/null || echo "expo-modules-core direct path not found"

          # Check if expo-module-gradle-plugin is properly included
          if ! grep -q "expo-module-gradle-plugin" settings.gradle; then
            echo "WARNING: expo-module-gradle-plugin not found in settings.gradle"
          fi

          # Ensure the settings.gradle has proper plugin resolution
          echo ""
          echo "=== Checking for plugin resolution issues ==="

          # Find the expo-modules-autolinking android gradle directory
          EXPO_AUTOLINKING=$(find -L ../node_modules -path "*/@expo/modules-autolinking/android" -type d 2>/dev/null | head -1)
          echo "Found expo-modules-autolinking at: $EXPO_AUTOLINKING"

          # The expo prebuild should generate proper includeBuild directives
          # If they're missing or pointing to wrong paths, we need to fix them

          # Check if the includeBuild paths exist
          grep -oP "includeBuild\(['\"]([^'\"]+)" settings.gradle | while read line; do
            path=$(echo "$line" | sed "s/includeBuild(['\"]//")
            if [ ! -d "$path" ]; then
              echo "WARNING: includeBuild path does not exist: $path"
            fi
          done || true

      - name: Fix Kotlin version compatibility
        working-directory: apps/mobile/android
        run: |
          # Fix Compose Compiler / Kotlin version mismatch
          # expo-modules-core uses a versionsMap that maps kotlinVersion() to compose compiler version
          # If the Kotlin version doesn't match exactly, Compose Compiler throws a compatibility error

          # Add kotlin.jvm.target.validation.mode to gradle.properties
          echo "" >> gradle.properties
          echo "kotlin.jvm.target.validation.mode=IGNORE" >> gradle.properties

          # Patch expo-modules-core build.gradle to hardcode compose compiler version
          # The file is in node_modules after prebuild; search everywhere under the mobile app
          echo "Searching for expo-modules-core build.gradle..."
          EXPO_CORE_GRADLE=$(find -L .. -path "*/expo-modules-core/android/build.gradle" -type f 2>/dev/null | head -1)
          if [ -n "$EXPO_CORE_GRADLE" ]; then
            echo "Found expo-modules-core at: $EXPO_CORE_GRADLE"
            echo "=== Before patch ==="
            grep -n "kotlinCompilerExtensionVersion\|composeOptions\|versionsMap" "$EXPO_CORE_GRADLE" || true
            # Replace versionsMap lookup with hardcoded version for Kotlin 1.9.24
            sed -i 's/kotlinCompilerExtensionVersion = versionsMap\[kotlinVersion()\]/kotlinCompilerExtensionVersion = "1.5.14"/' "$EXPO_CORE_GRADLE"
            echo "=== After patch ==="
            grep -n "kotlinCompilerExtensionVersion\|composeOptions\|versionsMap" "$EXPO_CORE_GRADLE" || true
          else
            echo "WARNING: expo-modules-core build.gradle not found via find"
            echo "Listing node_modules structure..."
            ls -la ../node_modules/ | head -20
            ls -la ../node_modules/expo-modules-core/android/ 2>/dev/null || echo "Direct path not found"
            # Try direct known path
            DIRECT_PATH="../node_modules/expo-modules-core/android/build.gradle"
            if [ -f "$DIRECT_PATH" ]; then
              echo "Found via direct path: $DIRECT_PATH"
              sed -i 's/kotlinCompilerExtensionVersion = versionsMap\[kotlinVersion()\]/kotlinCompilerExtensionVersion = "1.5.14"/' "$DIRECT_PATH"
              grep -n "kotlinCompilerExtensionVersion" "$DIRECT_PATH" || true
            else
              echo "CRITICAL: Cannot find expo-modules-core build.gradle"
              echo "Adding suppressKotlinVersionCompatibilityCheck to all Kotlin compile tasks..."
              # Fallback: add allprojects block to root build.gradle to suppress version check
              echo "" >> build.gradle
              echo "allprojects {" >> build.gradle
              echo "    tasks.withType(org.jetbrains.kotlin.gradle.tasks.KotlinCompile).configureEach {" >> build.gradle
              echo "        compilerOptions {" >> build.gradle
              echo "            freeCompilerArgs.addAll(['-P', 'plugin:androidx.compose.compiler.plugins.kotlin:suppressKotlinVersionCompatibilityCheck=1.9.24'])" >> build.gradle
              echo "        }" >> build.gradle
              echo "    }" >> build.gradle
              echo "}" >> build.gradle
              echo "Applied fallback patch to suppress Kotlin version check"
            fi
          fi

      - name: Build Android APK (Debug)
        working-directory: apps/mobile/android
        run: ./gradlew assembleDebug

      - name: Build Android APK (Release)
        working-directory: apps/mobile/android
        run: ./gradlew assembleRelease
        env:
          # For unsigned release builds
          # To sign, add ANDROID_KEYSTORE_* secrets
          ANDROID_KEYSTORE_FILE: ''

      - name: Sign APK (if keystore available)
        if: env.ANDROID_KEYSTORE_BASE64 != ''
        working-directory: apps/mobile
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > keystore.jks
          $ANDROID_HOME/build-tools/34.0.0/apksigner sign \
            --ks keystore.jks \
            --ks-key-alias ${{ secrets.ANDROID_KEY_ALIAS }} \
            --ks-pass pass:${{ secrets.ANDROID_KEYSTORE_PASSWORD }} \
            --key-pass pass:${{ secrets.ANDROID_KEY_PASSWORD }} \
            android/app/build/outputs/apk/release/app-release-unsigned.apk
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}

      - name: Rename APK files
        run: |
          VERSION="${{ github.event.inputs.version || github.ref_name }}"
          VERSION="${VERSION#v}"  # Remove 'v' prefix if present

          mkdir -p release

          # Copy debug APK
          if [ -f apps/mobile/android/app/build/outputs/apk/debug/app-debug.apk ]; then
            cp apps/mobile/android/app/build/outputs/apk/debug/app-debug.apk \
               release/CoBrain-${VERSION}-debug.apk
          fi

          # Copy release APK
          if [ -f apps/mobile/android/app/build/outputs/apk/release/app-release-unsigned.apk ]; then
            cp apps/mobile/android/app/build/outputs/apk/release/app-release-unsigned.apk \
               release/CoBrain-${VERSION}-android.apk
          fi

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cobrain-android
          path: release/*.apk
          if-no-files-found: error

  build-ios:
    runs-on: macos-latest
    if: github.event.inputs.build_ios == 'true' || (startsWith(github.ref, 'refs/tags/') && vars.BUILD_IOS == 'true')

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install

      - name: Setup EAS CLI
        run: npm install -g eas-cli

      - name: Generate native project
        working-directory: apps/mobile
        run: npx expo prebuild --platform ios --clean

      - name: Install CocoaPods dependencies
        working-directory: apps/mobile/ios
        run: pod install

      - name: Install Apple certificate
        if: env.IOS_CERTIFICATE_BASE64 != ''
        env:
          IOS_CERTIFICATE_BASE64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
          IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
          IOS_PROVISION_PROFILE_BASE64: ${{ secrets.IOS_PROVISION_PROFILE_BASE64 }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          # Create variables
          CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
          PP_PATH=$RUNNER_TEMP/build_pp.mobileprovision
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

          # Import certificate and provisioning profile from secrets
          echo -n "$IOS_CERTIFICATE_BASE64" | base64 --decode -o $CERTIFICATE_PATH
          echo -n "$IOS_PROVISION_PROFILE_BASE64" | base64 --decode -o $PP_PATH

          # Create temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # Import certificate to keychain
          security import $CERTIFICATE_PATH -P "$IOS_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

          # Apply provisioning profile
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp $PP_PATH ~/Library/MobileDevice/Provisioning\ Profiles

      - name: Build iOS (Simulator)
        working-directory: apps/mobile/ios
        run: |
          xcodebuild -workspace CoBrain.xcworkspace \
            -scheme CoBrain \
            -configuration Release \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 15' \
            -derivedDataPath build \
            build

      - name: Build iOS Archive (if signed)
        if: env.IOS_CERTIFICATE_BASE64 != ''
        working-directory: apps/mobile/ios
        env:
          IOS_CERTIFICATE_BASE64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
        run: |
          xcodebuild -workspace CoBrain.xcworkspace \
            -scheme CoBrain \
            -configuration Release \
            -sdk iphoneos \
            -archivePath build/CoBrain.xcarchive \
            archive

          xcodebuild -exportArchive \
            -archivePath build/CoBrain.xcarchive \
            -exportOptionsPlist ExportOptions.plist \
            -exportPath build/ipa

      - name: Upload iOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cobrain-ios
          path: |
            apps/mobile/ios/build/**/*.app
            apps/mobile/ios/build/ipa/*.ipa
          if-no-files-found: warn

  release:
    needs: [build-android]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: List artifacts
        run: find artifacts -type f || echo "No artifacts found"

      - name: Create/Update Release
        uses: softprops/action-gh-release@v1
        with:
          draft: true
          generate_release_notes: true
          files: |
            artifacts/**/*.apk
            artifacts/**/*.ipa
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
