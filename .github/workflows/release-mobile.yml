name: Release Mobile

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.1.0)'
        required: true
        type: string
      build_ios:
        description: 'Build iOS (requires secrets)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

env:
  EXPO_NO_TELEMETRY: 1

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Build workspace dependencies
        run: |
          pnpm --filter @cobrain/core build
          pnpm --filter @cobrain/database build

      - name: Setup Expo
        run: npm install -g eas-cli

      - name: Setup flat node_modules for native build
        working-directory: apps/mobile
        run: |
          # pnpm's symlink structure breaks Gradle plugin resolution for Expo native modules
          # Solution: replace workspace:* with file: refs in ALL packages and install fresh with npm

          # Patch apps/mobile/package.json
          python3 -c "
          import json, glob, os

          # Mapping of workspace package names to their file: paths (relative to apps/mobile)
          workspace_map = {
              '@cobrain/core': 'file:../../packages/core',
              '@cobrain/database': 'file:../../packages/database',
          }

          def patch_pkg(filepath, workspace_map_rel):
              with open(filepath) as f:
                  pkg = json.load(f)
              changed = False
              for section in ['dependencies', 'devDependencies', 'peerDependencies']:
                  deps = pkg.get(section, {})
                  for key in list(deps.keys()):
                      if deps[key] == 'workspace:*' and key in workspace_map_rel:
                          deps[key] = workspace_map_rel[key]
                          changed = True
              if changed:
                  with open(filepath, 'w') as f:
                      json.dump(pkg, f, indent=2)
                  print(f'Patched {filepath}')
              else:
                  print(f'No workspace:* found in {filepath}')

          # Patch mobile package.json
          patch_pkg('package.json', workspace_map)

          # Patch packages/database/package.json (it depends on @cobrain/core)
          db_map = {'@cobrain/core': 'file:../core'}
          patch_pkg('../../packages/database/package.json', db_map)
          "
          echo "=== Patched package.json files ==="
          grep -n 'cobrain' package.json || true
          grep -n 'cobrain' ../../packages/database/package.json || true

          # Prevent npm from discovering the pnpm workspace root
          # npm walks up to find root package.json with "workspaces" and tries to resolve all workspace:* refs
          rm -f ../../pnpm-workspace.yaml
          python3 -c "
          import json
          with open('../../package.json') as f:
              pkg = json.load(f)
          pkg.pop('workspaces', None)
          with open('../../package.json', 'w') as f:
              json.dump(pkg, f, indent=2)
          "

          rm -rf node_modules
          npm install --legacy-peer-deps
          # Fix ajv version mismatch: ajv-keywords@5 needs ajv@8 but npm may dedupe to ajv@6
          npm install ajv@8 --legacy-peer-deps
          # NativeWind babel preset requires react-native-worklets/plugin
          # Pin to ~0.4.0 for React Native 0.76 compatibility (0.7.x needs RN 0.81+)
          npm install react-native-worklets@~0.4.0 --legacy-peer-deps
          echo "=== Verifying key native modules ==="
          ls node_modules/expo-modules-core/android/build.gradle && echo "expo-modules-core: OK" || echo "expo-modules-core: MISSING"
          ls node_modules/expo-font/android/build.gradle && echo "expo-font: OK" || echo "expo-font: MISSING"

      - name: Generate native project
        working-directory: apps/mobile
        run: npx expo prebuild --platform android --clean

      - name: Fix Kotlin version compatibility
        working-directory: apps/mobile/android
        run: |
          # Fix Compose Compiler / Kotlin version mismatch
          # expo-modules-core uses a versionsMap that maps kotlinVersion() to compose compiler version
          # If the Kotlin version doesn't match exactly, Compose Compiler throws a compatibility error

          # Add kotlin.jvm.target.validation.mode to gradle.properties
          echo "" >> gradle.properties
          echo "kotlin.jvm.target.validation.mode=IGNORE" >> gradle.properties

          echo "Searching for expo-modules-core build.gradle..."

          # Local node_modules (npm flat install) takes priority - this is what Gradle uses
          LOCAL_PATH="../node_modules/expo-modules-core/android/build.gradle"
          ROOT_PATH="../../../node_modules/expo-modules-core/android/build.gradle"

          patch_file() {
            echo "Patching: $1"
            sed -i 's/kotlinCompilerExtensionVersion = versionsMap\[kotlinVersion()\]/kotlinCompilerExtensionVersion = "1.5.14"/' "$1"
            grep -n "kotlinCompilerExtensionVersion" "$1" || true
          }

          # Patch local node_modules (used by Gradle)
          if [ -f "$LOCAL_PATH" ]; then
            patch_file "$LOCAL_PATH"
          fi
          # Also patch root if it exists (belt and suspenders)
          if [ -f "$ROOT_PATH" ]; then
            patch_file "$ROOT_PATH"
          fi
          # Fallback search if neither found
          if [ ! -f "$LOCAL_PATH" ] && [ ! -f "$ROOT_PATH" ]; then
            echo "Searching with find..."
            find -L ../.. -path "*/expo-modules-core/android/build.gradle" -type f 2>/dev/null | while read f; do
              patch_file "$f"
            done
          fi

      - name: Build Android APK (Debug)
        working-directory: apps/mobile/android
        run: ./gradlew assembleDebug

      - name: Build Android APK (Release)
        working-directory: apps/mobile/android
        run: ./gradlew assembleRelease
        env:
          # For unsigned release builds
          # To sign, add ANDROID_KEYSTORE_* secrets
          ANDROID_KEYSTORE_FILE: ''

      - name: Sign APK (if keystore available)
        if: env.ANDROID_KEYSTORE_BASE64 != ''
        working-directory: apps/mobile
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > keystore.jks
          $ANDROID_HOME/build-tools/34.0.0/apksigner sign \
            --ks keystore.jks \
            --ks-key-alias ${{ secrets.ANDROID_KEY_ALIAS }} \
            --ks-pass pass:${{ secrets.ANDROID_KEYSTORE_PASSWORD }} \
            --key-pass pass:${{ secrets.ANDROID_KEY_PASSWORD }} \
            android/app/build/outputs/apk/release/app-release-unsigned.apk
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}

      - name: Rename APK files
        run: |
          VERSION="${{ github.event.inputs.version || github.ref_name }}"
          VERSION="${VERSION#v}"  # Remove 'v' prefix if present

          mkdir -p release

          # Copy debug APK
          if [ -f apps/mobile/android/app/build/outputs/apk/debug/app-debug.apk ]; then
            cp apps/mobile/android/app/build/outputs/apk/debug/app-debug.apk \
               release/CoBrain-${VERSION}-debug.apk
          fi

          # Copy release APK
          if [ -f apps/mobile/android/app/build/outputs/apk/release/app-release-unsigned.apk ]; then
            cp apps/mobile/android/app/build/outputs/apk/release/app-release-unsigned.apk \
               release/CoBrain-${VERSION}-android.apk
          fi

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cobrain-android
          path: release/*.apk
          if-no-files-found: error

  build-ios:
    runs-on: macos-latest
    if: github.event.inputs.build_ios == 'true' || (startsWith(github.ref, 'refs/tags/') && vars.BUILD_IOS == 'true')

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install

      - name: Setup EAS CLI
        run: npm install -g eas-cli

      - name: Generate native project
        working-directory: apps/mobile
        run: npx expo prebuild --platform ios --clean

      - name: Install CocoaPods dependencies
        working-directory: apps/mobile/ios
        run: pod install

      - name: Install Apple certificate
        if: env.IOS_CERTIFICATE_BASE64 != ''
        env:
          IOS_CERTIFICATE_BASE64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
          IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
          IOS_PROVISION_PROFILE_BASE64: ${{ secrets.IOS_PROVISION_PROFILE_BASE64 }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          # Create variables
          CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
          PP_PATH=$RUNNER_TEMP/build_pp.mobileprovision
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

          # Import certificate and provisioning profile from secrets
          echo -n "$IOS_CERTIFICATE_BASE64" | base64 --decode -o $CERTIFICATE_PATH
          echo -n "$IOS_PROVISION_PROFILE_BASE64" | base64 --decode -o $PP_PATH

          # Create temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # Import certificate to keychain
          security import $CERTIFICATE_PATH -P "$IOS_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

          # Apply provisioning profile
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp $PP_PATH ~/Library/MobileDevice/Provisioning\ Profiles

      - name: Build iOS (Simulator)
        working-directory: apps/mobile/ios
        run: |
          xcodebuild -workspace CoBrain.xcworkspace \
            -scheme CoBrain \
            -configuration Release \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 15' \
            -derivedDataPath build \
            build

      - name: Build iOS Archive (if signed)
        if: env.IOS_CERTIFICATE_BASE64 != ''
        working-directory: apps/mobile/ios
        env:
          IOS_CERTIFICATE_BASE64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
        run: |
          xcodebuild -workspace CoBrain.xcworkspace \
            -scheme CoBrain \
            -configuration Release \
            -sdk iphoneos \
            -archivePath build/CoBrain.xcarchive \
            archive

          xcodebuild -exportArchive \
            -archivePath build/CoBrain.xcarchive \
            -exportOptionsPlist ExportOptions.plist \
            -exportPath build/ipa

      - name: Upload iOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cobrain-ios
          path: |
            apps/mobile/ios/build/**/*.app
            apps/mobile/ios/build/ipa/*.ipa
          if-no-files-found: warn

  release:
    needs: [build-android]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: List artifacts
        run: find artifacts -type f || echo "No artifacts found"

      - name: Create/Update Release
        uses: softprops/action-gh-release@v1
        with:
          draft: true
          generate_release_notes: true
          files: |
            artifacts/**/*.apk
            artifacts/**/*.ipa
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
